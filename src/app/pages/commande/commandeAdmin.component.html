<div class="orders-management-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <button class="btn-back" routerLink="/admin/acceuilAdmin">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M15 10H5M10 5l-5 5 5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Retour
      </button>
      <div class="header-info">
        <h1>Gestion des Commandes</h1>
        <p class="subtitle">Suivez et g√©rez toutes les commandes de la plateforme</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-export" (click)="exportOrders()">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10 14V6M6 10l4-4 4 4M3 17h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Exporter
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card" [style.border-left-color]="'#f59e0b'">
      <div class="stat-icon pending">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 6v6l4 2" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="none"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3 class="stat-value">{{ stats.pending }}</h3>
        <p class="stat-label">En attente</p>
      </div>
    </div>

    <div class="stat-card" [style.border-left-color]="'#3b82f6'">
      <div class="stat-icon processing">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M9 2L7 6M17 2l2 4M3 6h18M5 6l2 14h10l2-14" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3 class="stat-value">{{ stats.processing }}</h3>
        <p class="stat-label">En pr√©paration</p>
      </div>
    </div>

    <div class="stat-card" [style.border-left-color]="'#8b5cf6'">
      <div class="stat-icon delivery">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M16 8h5l3 3v5h-3M1 11h3M9 17a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM19 17a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM13 11h3v-3H4v6h3" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3 class="stat-value">{{ stats.delivery }}</h3>
        <p class="stat-label">En livraison</p>
      </div>
    </div>

    <div class="stat-card" [style.border-left-color]="'#48bb78'">
      <div class="stat-icon completed">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M20 6L9 17l-5-5" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="stat-content">
        <h3 class="stat-value">{{ stats.completed }}</h3>
        <p class="stat-label">Termin√©es</p>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="search-box">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
        <path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16zM18 18l-4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <input 
        type="text" 
        placeholder="Rechercher par ID, client..."
        [(ngModel)]="searchQuery"
        (input)="filterOrders()">
    </div>
    
    <select class="filter-select" [(ngModel)]="filterStatus" (change)="filterOrders()">
      <option value="">Tous les statuts</option>
      <option value="EN_ATTENTE">En attente</option>
      <option value="CONFIRMEE">Confirm√©e</option>
      <option value="EN_PREPARATION">En pr√©paration</option>
      <option value="EN_LIVRAISON">En livraison</option>
      <option value="LIVREE">Livr√©e</option>
      <option value="ANNULEE">Annul√©e</option>
    </select>

    <select class="filter-select" [(ngModel)]="filterPayment" (change)="filterOrders()">
      <option value="">Tous les paiements</option>
      <option value="PAYE">Pay√©</option>
      <option value="EN_ATTENTE">En attente</option>
      <option value="ECHOUE">√âchou√©</option>
    </select>
    
    <input 
      type="date" 
      class="filter-date" 
      [(ngModel)]="filterDate"
      (change)="filterOrders()">
    
    <select class="filter-select" [(ngModel)]="sortBy" (change)="sortOrders()">
      <option value="recent">Plus r√©cent</option>
      <option value="oldest">Plus ancien</option>
      <option value="amount-desc">Montant d√©croissant</option>
      <option value="amount-asc">Montant croissant</option>
    </select>
  </div>

  <!-- Orders Table -->
  <div class="table-card">
    <div class="table-header">
      <h3>Commandes ({{ filteredOrders.length }})</h3>
      <div class="table-actions">
        <button class="btn-refresh" (click)="refreshOrders()">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M4 4v5h5M16 16v-5h-5M18 10a8 8 0 1 1-2.5-5.8" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="none"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="table-container" *ngIf="paginatedOrders.length > 0">
      <table class="orders-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Client</th>
            <th>Date</th>
            <th>Montant</th>
            <th>Paiement</th>
            <th>Statut</th>
            <th>Livraison</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let order of paginatedOrders" [class.highlight]="order.id === highlightedOrderId">
            <td class="order-id">#{{ order.id }}</td>
            <td>
              <div class="client-cell">
                <div class="client-avatar">{{ getInitials(order.client?.nomComplet) }}</div>
                <div class="client-info">
                  <span class="client-name">{{ order.client?.nomComplet }}</span>
                  <span class="client-email">{{ order.client?.email }}</span>
                </div>
              </div>
            </td>
            <td class="date-cell">
              <div class="date-info">
                <span class="date">{{ order.created_at | date: 'dd/MM/yyyy' }}</span>
                <span class="time">{{ order.created_at | date: 'HH:mm' }}</span>
              </div>
            </td>
            <td class="amount-cell">{{ order.montant_total }} Fr</td>
            <td>
              <span class="payment-badge" [ngClass]="order.paiement?.statut?.toLowerCase()">
                {{ order.paiement?.statut }}
              </span>
            </td>
            <td>
              <div class="status-cell">
                <span class="status-badge" [ngClass]="order.statut.toLowerCase()">
                  {{ getStatusLabel(order.statut) }}
                </span>
              </div>
            </td>
            <td class="delivery-cell">
              <div class="delivery-info">
                <span class="delivery-type">Livraison √† Domicile</span>
                <span class="delivery-date" *ngIf="order.livraison?.date_livraison">
                  {{ order.livraison?.date_livraison | date: 'dd/MM' }}
                </span>
              </div>
            </td>
            <td>
              <div class="table-actions-cell">
                <button class="btn-table-action" (click)="viewOrderDetails(order)" title="Voir d√©tails">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M1 8s3-5 7-5 7 5 7 5-3 5-7 5-7-5-7-5z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <circle cx="8" cy="8" r="2" fill="currentColor"/>
                  </svg>
                </button>
                <button class="btn-table-action"  title="Changer statut">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
                <td>
  <div class="table-actions-cell">
    <button class="btn-table-action" (click)="viewOrderDetails(order)" title="Voir d√©tails">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M1 8s3-5 7-5 7 5 7 5-3 5-7 5-7-5-7-5z" stroke="currentColor" stroke-width="1.5" fill="none"/>
        <circle cx="8" cy="8" r="2" fill="currentColor"/>
      </svg>
    </button>
    
    <div class="dropdown-container">
      <button class="btn-table-action" (click)="toggleStatusMenu(order.id)" title="Changer statut">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      
      <div class="dropdown-menu" *ngIf="activeMenuOrderId === order.id">
        <button class="dropdown-item" (click)="updateOrderStatus(order, 'CONFIRMEE')">
          <span class="menu-icon">‚úì</span> Confirmer
        </button>
        <button class="dropdown-item" (click)="updateOrderStatus(order, 'EN_PREPARATION')">
          <span class="menu-icon">üì¶</span> En pr√©paration
        </button>
        <button class="dropdown-item" (click)="updateOrderStatus(order, 'EN_LIVRAISON')">
          <span class="menu-icon">üöö</span> En livraison
        </button>
        <button class="dropdown-item" (click)="updateOrderStatus(order, 'LIVREE')">
          <span class="menu-icon">‚úÖ</span> Livr√©e
        </button>
        <button class="dropdown-item danger" (click)="updateOrderStatus(order, 'ANNULEE')">
          <span class="menu-icon">‚ùå</span> Annuler
        </button>
      </div>
    </div>
    
    <button class="btn-table-action print" (click)="printOrder(order)" title="Imprimer">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
        <path d="M4 5V2h8v3M4 11H2V7h12v4h-2M4 11h8v3H4z" stroke="currentColor" stroke-width="1.5" fill="none"/>
      </svg>
    </button>
  </div>
</td>
                <button class="btn-table-action print" (click)="printOrder(order)" title="Imprimer">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M4 5V2h8v3M4 11H2V7h12v4h-2M4 11h8v3H4z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredOrders.length === 0">
      <div class="empty-icon">üì¶</div>
      <h3>Aucune commande trouv√©e</h3>
      <p>Aucune commande ne correspond √† vos crit√®res</p>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="filteredOrders.length > pageSize">
      <button class="pagination-btn" [disabled]="currentPage === 1" (click)="previousPage()">
        Pr√©c√©dent
      </button>
      <div class="pagination-info">
        Page {{ currentPage }} sur {{ totalPages }} ({{ filteredOrders.length }} commandes)
      </div>
      <button class="pagination-btn" [disabled]="currentPage === totalPages" (click)="nextPage()">
        Suivant
      </button>
    </div>
  </div>
</div>

<!-- Order Details Modal -->
<div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
  <div class="modal-content large" (click)="$event.stopPropagation()">
    <button class="modal-close" (click)="closeDetailsModal()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    
    <div class="modal-body" *ngIf="selectedOrder">
      <!-- Order Header -->
      <div class="order-header">
        <div class="order-header-left">
          <h2>Commande #{{ selectedOrder.id }}</h2>
          <span class="order-date">{{ selectedOrder.created_at | date: 'dd MMMM yyyy √† HH:mm' }}</span>
        </div>
        <div class="order-header-right">
          <span class="status-badge large" [ngClass]="selectedOrder.statut.toLowerCase()">
            {{ getStatusLabel(selectedOrder.statut) }}
          </span>
        </div>
      </div>

      <div class="modal-grid">
        <!-- Client Info -->
        <div class="info-section">
          <h3>
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 2a4 4 0 1 0 0 8 4 4 0 0 0 0-8zM3 18v-2a5 5 0 0 1 5-5h4a5 5 0 0 1 5 5v2" stroke="currentColor" stroke-width="1.5" fill="none"/>
            </svg>
            Informations client
          </h3>
          <div class="info-content">
            <div class="info-item">
              <span class="info-label">Nom</span>
              <span class="info-value">{{ selectedOrder.client?.nomComplet }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Email</span>
              <span class="info-value">{{ selectedOrder.client?.email }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">T√©l√©phone</span>
              <span class="info-value">{{ selectedOrder.client?.tel || 'N/A' }}</span>
            </div>
          </div>
        </div>

        <!-- Delivery Info -->
        <div class="info-section">
          <h3>
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M14 6h4l2 2v4h-2M2 8h2M7 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4zM15 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4zM11 8h2V6H4v4h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            Livraison
          </h3>
          <div class="info-content">
            <div class="info-item">
              <span class="info-label">Type</span>
              <span class="info-value">Livraison √† Domicile</span>
            </div>
            <div class="info-item">
              <span class="info-label">Adresse</span>
              <span class="info-value">{{ selectedOrder.livraison?.adresse_livraison || 'N/A' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Date pr√©vue</span>
              <span class="info-value">{{ selectedOrder.livraison?.date_livraison | date: 'dd/MM/yyyy' }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Frais</span>
              <span class="info-value">{{ selectedOrder.livraison?.frais_livraison || 0 }} Fr</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Items -->
      <div class="order-items-section">
        <h3>Produits command√©s (5)</h3>
        <div class="order-items-list">
          <div class="order-item" *ngFor="let item of getLignes(selectedOrder)">
            <div class="item-image">
              <img [src]="getImageUrl(item.produit!.images[0]?.chemin)" [alt]="item.produit?.nom">
            </div>
            <div class="item-details">
              <h4>{{ item.produit?.nom }}</h4>
              <p class="item-producer">{{ item.produit?.producteur?.utilisateur?.nomComplet }}</p>
              <p class="item-quantity">Quantit√© : {{ item.quantite }}</p>
            </div>
            <div class="item-prices">
              <span class="item-unit-price">{{ item.prix }} Fr</span>
              <span class="item-total-price">{{ item.montantLigne }} Fr</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Summary -->
      <div class="payment-summary">
        <div class="summary-row">
          <span>Sous-total</span>
          <span>{{ calculateSubtotal(selectedOrder) }} Fr</span>
        </div>
        <div class="summary-row">
          <span>Frais de livraison</span>
          <span>{{ selectedOrder.livraison?.frais_livraison || 0 }} Fr</span>
        </div>
        <div class="summary-row total">
          <span>Total</span>
          <span>{{ selectedOrder.montant_total }} Fr</span>
        </div>
        <div class="payment-status">
          <span>Statut paiement :</span>
          <span class="payment-badge" [ngClass]="selectedOrder.paiement?.statut?.toLowerCase()">
            {{ selectedOrder.paiement?.statut }}
          </span>
        </div>
      </div>

      <!-- Actions -->
      <div class="modal-actions-footer">
        <button class="btn-secondary" (click)="printOrder(selectedOrder)">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M5 6V3h10v3M5 13H3V8h14v5h-2M5 13h10v4H5z" stroke="currentColor" stroke-width="1.5" fill="none"/>
          </svg>
          Imprimer
        </button>
        <button class="btn-primary" (click)="contactClient(selectedOrder)">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path d="M3 4h14a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1zM2 5l8 5 8-5" stroke="currentColor" stroke-width="1.5" fill="none"/>
          </svg>
          Contacter le client
        </button>
      </div>
    </div>
  </div>
</div>